from django.contrib.auth import logout
from django.contrib.auth import logout
from django.shortcuts import render

# from csci4830.libraryshop.models import BookSection


# Also look at urls.py
# Visit the very top directory (/)


def index(request):
    from libraryshop.models import Book
    """This is the function that is executed when the root (/) url is called.

    It is called in urls.py (in the csci4830 controller folder, the last one)
    """
    varSetInViews = "Please check views.py to see the variable for this string."

    # The following line queries the database for all the book objects , then prints their ID numbers generated by django
    for book in Book.objects.all():
        print(book.id)

    # We pass this to render() in the return statement to give the template variable values to insert in the html
    context = {
        "passedVariableFromRender":  varSetInViews,
        'pagetitle': "Index File",
    }

    return render(request, "skeleton.html", context)


def book(request):
    from libraryshop.models import Book
    # This will list all the book genres and print it in an unordered list, for example purposes
    allGenres = Book.ENUM_GENRES
  # Note how resultstring is initalized as a string?
    resultstr = '<ul>'

   # For (each) loop going through every genre, wrapping string with html list elements
    for book in allGenres:
        resultstr += "<li>" + book[1] + "</li>"
    resultstr += '</ul>'

    # Context variable. Note the pagetitle and passedVariableFromRender? You'll see them in the template files between braces: {{ pagetitle }}
    context = {
        'pagetitle': "Book page",
        # Note that HTML isn't escaped because |safe is mark in the skeleton.html template.
        'passedVariableFromRender': resultstr
    }

    # We are using the base template skeleton.html, which is in the templates folder
    return render(request, "skeleton.html", context)


def search(request):
    # Initialize
    from libraryshop.forms import SearchBookForm
    hadQuery = False
    form = SearchBookForm()

    context = {
        'form': form
    }

    # Search for submitted POST queries
    if request.method != 'POST':
        return render(request, "search.html", context)

    title = request.POST['title']
    author = request.POST['author']
    isbn = request.POST['ISBN']
    genre = request.POST['genre']
    date_before_month = request.POST['search_date_before_month']
    date_before_day = request.POST['search_date_before_day']
    date_before_year = request.POST['search_date_before_year']

    date_after_month = request.POST['search_date_after_month']
    date_after_day = request.POST['search_date_after_day']
    date_after_year = request.POST['search_date_after_year']

    from libraryshop.models import Book
    from django.db.models import Q  # Trust the plan!

    results = Book.objects.all()

    if (title != "" and title != None):
        hadQuery = True
        print("title")
        results = results.filter(title__icontains=title)
    if (author):
        hadQuery = True
        print("author")
        results = results.filter(author__exact=author)
        print(results)
    if (isbn):
        hadQuery = True
        results = results.filter(isbn__icontains=isbn)
    if (genre):
        hadQuery = True
        results = results.filter(genre__exact=genre)
    if (date_before):
        pass
        #results = results.filter()

    if hadQuery == False:
        return render(request, "search.html", context)

    print(results)

    return render(request, "search.html", context)


def browse(request):
    pass


######

def login(request):
    from libraryshop.models import User
    from django.contrib.auth import authenticate, login

    login_status_mesg = ''
    postUsername = request.POST.get('username')
    postPassword = request.POST.get('password')
    session_user = None

    if User.objects.filter(username=postUsername).count() == 0:
        login_status_mesg += 'User does not exist!'
    elif (session_user := authenticate(request, username=postUsername, password=postPassword)) == None:
        login_status_mesg += 'Invalid username and password combination!'
    # else:
        # login_status_mesg += 'Invalid username and password combination!'

    print(login_status_mesg)
    from libraryshop.forms import LoginForm

    context = {
        'login_form': LoginForm(),
        'content_site': 'login.html',
        'login_status_mesg': login_status_mesg
    }
    return render(request, "registration/login.html", context)


def logout_view(request):
    logout(request)
